# GitHub Actions CI/CD Pipeline: Project Chimera
# Prepared By: habeneyasu
# Repository: https://github.com/habeneyasu/chimera-factory

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - task-*
  pull_request:
    branches:
      - main
      - develop
      - task-*

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "latest"

jobs:
  # Job 1: Spec Validation
  spec-check:
    name: Spec Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Run spec-check
        run: make spec-check

  # Job 2: Linting
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: make setup

      - name: Run ruff (linter)
        run: uv run ruff check . --output-format=github || echo "âš ï¸  Ruff not configured yet (expected in early stages)"

      - name: Run mypy (type checker)
        run: uv run mypy src/ tests/ --ignore-missing-imports || echo "âš ï¸  Type checking warnings (expected until implementations are added)"

  # Job 3: Tests (Docker-based)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow failures in TDD stage
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services (PostgreSQL, Weaviate, Redis)
        run: |
          docker compose up -d postgres weaviate redis
          echo "Waiting for services to be healthy..."
          timeout 60 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done' || true

      - name: Build Docker image
        run: docker compose build test

      - name: Run tests
        id: test_run
        run: make test || echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Stop services
        if: always()
        run: docker compose down

      - name: Test Results Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests executed via Docker" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### TDD Approach (Expected Failures)" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  Tests are **intentionally failing** until implementations are added." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is expected behavior in the TDD (Test-Driven Development) approach:" >> $GITHUB_STEP_SUMMARY
          echo "- Tests define the 'empty slots' that must be implemented" >> $GITHUB_STEP_SUMMARY
          echo "- Failures (ModuleNotFoundError) indicate missing modules" >> $GITHUB_STEP_SUMMARY
          echo "- Once implementations are added, tests should pass" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See test output above for details." >> $GITHUB_STEP_SUMMARY

  # Job 4: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: make setup

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r "password\|secret\|api_key\|token" --include="*.py" --include="*.yml" --include="*.yaml" src/ tests/ skills/ 2>/dev/null | grep -v "#\|TODO\|FIXME\|example\|test" | grep -v "\.git" | grep -v "__pycache__"; then
            echo "âš ï¸  Potential secrets found. Review manually."
            exit 0  # Don't fail, just warn
          else
            echo "âœ“ No obvious secrets found"
          fi

      - name: Check dependency vulnerabilities
        run: |
          echo "Checking dependencies..."
          uv pip list || echo "âš ï¸  Dependency check not fully configured"

  # Job 5: Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify Dockerfile builds
        run: docker build -t chimera-factory:test -f Dockerfile .

      - name: Verify docker-compose
        run: docker compose config

  # Summary Job (runs after all jobs)
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [spec-check, lint, test, security, build]
    if: always()
    steps:
      - name: CI Pipeline Summary
        run: |
          echo "## ðŸ­ Project Chimera CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Spec Check: ${{ needs.spec-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }} âš ï¸ (Expected to fail in TDD stage)" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### TDD Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Tests are intentionally failing** - This is expected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The TDD (Test-Driven Development) approach requires:" >> $GITHUB_STEP_SUMMARY
          echo "1. Write failing tests first (âœ… Done)" >> $GITHUB_STEP_SUMMARY
          echo "2. Implement code to make tests pass (ðŸ“‹ Next step)" >> $GITHUB_STEP_SUMMARY
          echo "3. Refactor and improve (ðŸ”„ Continuous)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Current failures are due to missing implementations (ModuleNotFoundError), which is correct for this stage." >> $GITHUB_STEP_SUMMARY
