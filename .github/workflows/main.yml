# GitHub Actions CI/CD Pipeline: Project Chimera
# Prepared By: habeneyasu
# Repository: https://github.com/habeneyasu/chimera-factory

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - task-*
  pull_request:
    branches:
      - main
      - develop
      - task-*

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "latest"

jobs:
  # Job 1: Spec Validation
  spec-check:
    name: Spec Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Run spec-check
        run: make spec-check

  # Job 2: Linting
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: make setup

      - name: Run ruff (linter)
        run: uv run ruff check . --output-format=github || echo "âš ï¸  Ruff not configured yet (expected in early stages)"

      - name: Run mypy (type checker)
        run: uv run mypy src/ tests/ --ignore-missing-imports || echo "âš ï¸  Type checking warnings (expected until implementations are added)"

  # Job 3: Tests (Docker-based)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build test

      - name: Run tests
        run: make test

      - name: Test Results Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests executed via Docker" >> $GITHUB_STEP_SUMMARY
          echo "- See logs above for detailed results" >> $GITHUB_STEP_SUMMARY

  # Job 4: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: make setup

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -r "password\|secret\|api_key\|token" --include="*.py" --include="*.yml" --include="*.yaml" src/ tests/ skills/ 2>/dev/null | grep -v "#\|TODO\|FIXME\|example\|test" | grep -v "\.git" | grep -v "__pycache__"; then
            echo "âš ï¸  Potential secrets found. Review manually."
            exit 0  # Don't fail, just warn
          else
            echo "âœ“ No obvious secrets found"
          fi

      - name: Check dependency vulnerabilities
        run: |
          echo "Checking dependencies..."
          uv pip list || echo "âš ï¸  Dependency check not fully configured"

  # Job 5: Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify Dockerfile builds
        run: docker build -t chimera-factory:test -f Dockerfile .

      - name: Verify docker-compose
        run: docker compose config

  # Summary Job (runs after all jobs)
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [spec-check, lint, test, security, build]
    if: always()
    steps:
      - name: CI Pipeline Summary
        run: |
          echo "## ðŸ­ Project Chimera CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "- Spec Check: ${{ needs.spec-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Tests are expected to fail until implementations are added (TDD approach)." >> $GITHUB_STEP_SUMMARY
